name: Deploy (Docker)
run-name: Deploying [${{ inputs.environment }}] by @${{ github.actor }}

on:
  workflow_dispatch:
    inputs:
      environment:
        description: Deployment environment
        required: true
        type: choice
        options:
          - ne
        default: ne

jobs:
  deploy:
    name: Deploy to ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@master
        env:
          APP_ENV_FILE: ${{ secrets.ENV_FILE }}
          GITHUB_SHA: ${{ github.sha }}
          REMOTE_PATH: ${{ secrets.REMOTE_PATH }}
          HEALTH_URL: ${{ secrets.HEALTH_URL }}
          GIT_BRANCH: ${{ github.ref_name }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          password: ${{ secrets.SSH_PASSWORD }}
          envs: APP_ENV_FILE,GITHUB_SHA,REMOTE_PATH,HEALTH_URL,GIT_BRANCH
          script: |
            set -euo pipefail

            cd "${REMOTE_PATH}"

            # Pull latest code
            git fetch origin
            git checkout "${GIT_BRANCH}"
            git pull origin "${GIT_BRANCH}"

            # Write environment file
            if [ -n "${APP_ENV_FILE:-}" ]; then
              printf "%s" "${APP_ENV_FILE}" > .env
            fi

            # Save current container ID for rollback
            PREVIOUS_CONTAINER_ID=""
            if docker ps -a --filter "name=pdf_parser" --format "{{.ID}}" | grep -q .; then
              PREVIOUS_CONTAINER_ID=$(docker ps -a --filter "name=pdf_parser" --format "{{.ID}}")
            fi

            # Build new image
            docker-compose build

            # Stop old container
            docker-compose down || true

            # Start new container
            docker-compose up -d

            # Health check with retries
            HEALTH_URL="${HEALTH_URL:-http://localhost:29999/health}"
            RETRIES=20
            DELAY=3
            SUCCESS=false

            for i in $(seq 1 ${RETRIES}); do
              echo "Health check attempt ${i}/${RETRIES}..."
              if curl -fsS --max-time 5 "${HEALTH_URL}" >/dev/null 2>&1; then
                echo "Health check passed!"
                SUCCESS=true
                break
              fi
              if [ ${i} -lt ${RETRIES} ]; then
                sleep ${DELAY}
              fi
            done

            # Rollback on health check failure
            if [ "${SUCCESS}" = "false" ]; then
              echo "Health check failed after ${RETRIES} attempts. Rolling back..."
              docker-compose down || true

              if [ -n "${PREVIOUS_CONTAINER_ID}" ]; then
                docker start ${PREVIOUS_CONTAINER_ID}
                echo "Rolled back to previous container: ${PREVIOUS_CONTAINER_ID}"
              fi

              exit 1
            fi

            # Cleanup old images (keep last 5)
            docker images "pdf_parser" --format "{{.ID}}" | tail -n +6 | xargs -r docker rmi || true

            echo "Deployment successful!"

      - name: Workflow Summary
        if: always()
        run: |
          echo "### Deployment Details ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | ${{ github.event.inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **SHA** | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
